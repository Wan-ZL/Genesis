# Run Log: 2026-02-04 04:44

## Focus
Issue #19: [Bug] Encrypted API keys sent to external APIs due to decryption failure (priority-critical)

## Changes
- `assistant/server/services/settings.py`:
  - Fixed `_decrypt_if_sensitive()` to return empty string when encryption service unavailable
  - Previously returned the raw encrypted value, causing ENC:v1:... to leak
  - Added detailed error logging with exception type and message
  - Added sanity check to detect double-encryption bugs

- `assistant/server/routes/settings.py`:
  - Added `_validate_api_key()` function to check keys before applying to runtime config
  - Blocks any value starting with ENC:v1: prefix from being used
  - Updated `_apply_runtime_settings()` to validate keys before setting config values
  - Enhanced `load_settings_on_startup()` with decryption validation
  - Logs clear errors when decryption fails during startup

- `assistant/server/routes/chat.py`:
  - Added `_validate_api_key_safe()` function as final safety check
  - Modified `get_anthropic_client()` to return None for encrypted keys
  - Modified `get_openai_client()` to return None for encrypted keys
  - Prevents encrypted values from ever being sent to external APIs

- `assistant/tests/test_settings.py`:
  - Added `TestEncryptedValueLeakPrevention` test class with 6 new tests:
    - `test_encrypted_value_not_leaked_when_encryption_unavailable`
    - `test_encrypted_value_not_leaked_in_get_all`
    - `test_api_key_validation_rejects_encrypted_values`
    - `test_startup_validation_detects_decryption_failure`
    - `test_chat_api_rejects_encrypted_api_key`
    - `test_chat_client_returns_none_for_encrypted_key`

## Result
SUCCESS - Issue #19 fix implemented. Three-layer protection now prevents encrypted values from leaking:

1. **Layer 1 - Settings Service**: `_decrypt_if_sensitive()` returns empty string when decryption fails
2. **Layer 2 - Runtime Config**: `_validate_api_key()` blocks any ENC:v1: prefixed value
3. **Layer 3 - API Client**: `_validate_api_key_safe()` blocks encrypted keys at client creation

## Tests
- 673 tests passing (6 new for leak prevention)
- All existing tests continue to work

## How to Test
```bash
cd $GENESIS_DIR/assistant

# Run the new leak prevention tests
python3 -m pytest tests/test_settings.py::TestEncryptedValueLeakPrevention -v

# Run all settings tests
python3 -m pytest tests/test_settings.py -v

# Run full test suite
python3 -m pytest tests/ -v
```

## Next
Issue #19 labeled `needs-verification` for Criticizer verification.
