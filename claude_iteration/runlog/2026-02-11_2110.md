# Runlog: 2026-02-11 21:10

## Issue
**#50: Profile export endpoint unreachable due to route ordering**

## Problem
FastAPI route matcher was treating "export" as a section name because the parameterized `/profile/{section}` route was defined BEFORE the specific `/profile/export` route. This caused the export endpoint to return a 400 error ("Invalid section: export") instead of the expected JSON export data.

## Root Cause
Route ordering in FastAPI matters. Routes are matched in the order they are defined. Specific routes like `/profile/export` must be defined BEFORE parameterized routes like `/profile/{section}`, otherwise FastAPI will match "export" as a path parameter and route it to the wrong handler.

## Solution
Reordered routes in `assistant/server/routes/user_profile.py`:

### Before (broken):
```python
@router.get("/profile")          # Full profile
@router.get("/profile/{section}") # Parameterized section (catches "export")
@router.put("/profile/{section}")
@router.delete("/profile/{section}/{key}")
@router.get("/profile/export")   # Never reached!
@router.post("/profile/import")  # Never reached!
```

### After (fixed):
```python
@router.get("/profile")          # Full profile
@router.get("/profile/export")   # Specific route FIRST
@router.post("/profile/import")  # Specific route FIRST
@router.get("/profile/{section}") # Parameterized route AFTER
@router.put("/profile/{section}")
@router.delete("/profile/{section}/{key}")
```

## Changes Made
1. **File: assistant/server/routes/user_profile.py**
   - Moved `/profile/export` (GET) from line 117 to line 17 (before parameterized routes)
   - Moved `/profile/import` (POST) from line 130 to line 30 (before parameterized routes)
   - No logic changes, only reordering

2. **File: assistant/tests/test_user_profile.py**
   - Added regression test: `test_export_route_not_caught_by_section_route`
   - Test verifies that export returns proper dict structure (version, exported_at, sections)
   - Test documents the Issue #50 bug in comments for future reference

## Test Results
```bash
# User profile tests
cd assistant && python3 -m pytest tests/test_user_profile.py -v
# Result: 22/22 passed (including new regression test)

# Full test suite
cd assistant && python3 -m pytest tests/ -q
# Result: 1237 passed, 2 failed (pre-existing), 2 skipped
```

## Verification Steps
Added detailed comment to Issue #50 with verification instructions:
1. Start server
2. Test `curl http://127.0.0.1:8080/api/profile/export` — should return 200 with JSON
3. Test `curl http://127.0.0.1:8080/api/profile/personal_info` — should still work
4. Verify invalid sections still return 400

## Edge Cases Considered
- Export endpoint now works (200 instead of 400)
- Import endpoint still works (POST)
- Parameterized section routes still work for valid sections
- Invalid section names still return proper 400 error
- Other routes (DELETE /profile, POST /profile/aggregate) unaffected

## Next Step
Waiting for Criticizer to verify the fix by:
1. Starting the actual server
2. Testing curl commands against /api/profile/export
3. Confirming no regression in /api/profile/{section} behavior
4. Closing Issue #50 if verification passes

## Notes
- This is a classic FastAPI route ordering bug
- No logic changes, only route definition order
- Fix is backward compatible (no API changes)
- Similar bugs may exist in other route files (worth checking)

## Labels Applied
- `needs-verification` — Requesting Criticizer review
