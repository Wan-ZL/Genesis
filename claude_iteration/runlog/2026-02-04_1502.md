# Run Log: 2026-02-04 15:02

## Focus
Issue #27: [Bug] API keys from .env file not synced to Settings UI

## Root Cause
Two separate configuration sources existed without synchronization:
1. **Environment files** (`.claude/openai-key-secrets.env`) - loaded by `config.py` at startup
2. **SQLite database** (`memory/conversations.db` settings table) - used by Settings UI

When API keys existed only in .env files, `get_display_settings()` only checked SQLite and returned empty, showing "Not set" in UI even though the backend worked fine using the .env keys.

## Changes Made

### File: `assistant/server/services/settings.py`

**Modified `get_display_settings()` method:**
- Added optional `config_module` parameter (defaults to importing `config` module)
- Implemented fallback chain: SQLite → config module → empty string
- For API keys: `settings.get("openai_api_key") or config_module.OPENAI_API_KEY or ""`
- SQLite values take precedence (user preference), then fall back to .env values
- Returns accurate combined status from both sources

**Why this approach (Option B from issue):**
- **Read-only**: Doesn't modify database or files (safest)
- **Respects user intent**: If user sets via UI, that takes priority
- **No startup overhead**: No database writes on every startup
- **Backward compatible**: Existing behavior unchanged if SQLite has values

### File: `assistant/tests/test_settings.py`

**Added 3 comprehensive tests:**

1. **`test_display_settings_falls_back_to_config_module`**
   - SQLite empty, config module has keys
   - Verifies keys from .env shown as "Set" with proper masking
   - Tests Issue #27 fix directly

2. **`test_display_settings_sqlite_overrides_config`**
   - SQLite has key, config module has different key
   - Verifies SQLite takes precedence (user preference)
   - Ensures .env keys don't override UI-configured keys

3. **`test_display_settings_empty_in_both_sources`**
   - Both SQLite and config module empty
   - Verifies correct "Not set" status
   - Handles None vs empty string edge cases

## Result
**SUCCESS** - Issue #27 implementation complete.

### Test Results
- ✅ 3 new tests pass
- ✅ All existing settings tests pass
- ✅ Manual E2E test confirms fix works

### Edge Cases Handled
- ✅ SQLite empty, .env has key → Shows "Set"
- ✅ SQLite has key, .env has different key → Shows SQLite key
- ✅ Both empty → Shows "Not set"
- ✅ None vs empty string → Handled correctly
- ✅ Only one source has key → Shows that key

## How to Test

### Automated Tests
```bash
cd /Volumes/Storage/Server/Startup/Genesis/assistant

# New tests
python3 -m pytest tests/test_settings.py::TestSettingsService::test_display_settings_falls_back_to_config_module -v
python3 -m pytest tests/test_settings.py::TestSettingsService::test_display_settings_sqlite_overrides_config -v
python3 -m pytest tests/test_settings.py::TestSettingsService::test_display_settings_empty_in_both_sources -v

# All settings tests
python3 -m pytest tests/test_settings.py -v
```

### Manual E2E Test
```bash
cd /Volumes/Storage/Server/Startup/Genesis/assistant

# 1. Verify .env file has API key
cat ../.claude/openai-key-secrets.env

# 2. Clear SQLite (to simulate fresh install)
rm -f memory/conversations.db

# 3. Start server
python3 -m server.main

# 4. Open http://127.0.0.1:8080
# 5. Click Settings button
# 6. Verify OpenAI API Key shows "Set" (not "Not set")
# 7. Verify masked value shows ****xxxx
```

### Manual Test Results
```
✓ Test 1: Falls back to config when SQLite empty
✓ Test 2: SQLite overrides config
✓ Test 3: Shows not set when empty in both sources
```

## Design Rationale

### Why Option B (combined status) vs Option A (sync to SQLite)?
- **Safety**: Read-only approach, no database writes
- **User intent**: Respects UI-configured values over .env
- **Performance**: No startup overhead
- **Simplicity**: Single method change, no migration logic

### Why SQLite takes precedence?
- User explicitly set it via Settings UI
- More recent than .env file
- Allows overriding .env without editing files
- Consistent with "UI is source of truth for user preferences"

## Next Steps
1. Issue #27 marked with `needs-verification` label ✓
2. Criticizer should verify:
   - Settings UI shows "Set" for API keys in .env files
   - Masked values display correctly (****xxxx)
   - SQLite values override .env when both exist
   - Backend continues to work with .env keys
   - Chat API can still call OpenAI/Claude
   - All automated tests pass

## Technical Notes

### Fallback Chain
```python
# For each API key:
final_value = (
    settings.get("openai_api_key")  # SQLite (user preference)
    or config_module.OPENAI_API_KEY  # .env file (default)
    or ""                             # Empty if neither
)
```

### Import Strategy
- `config_module` parameter allows dependency injection (testability)
- Defaults to `import config` if not provided (production use)
- Avoids circular import issues at module level

### Backward Compatibility
- Existing behavior unchanged if SQLite has values
- Only adds fallback when SQLite is empty
- No breaking changes to API contract
- All existing tests pass

This fix resolves user confusion about API key configuration and provides a more intuitive experience for users who configure keys via .env files during initial setup.
