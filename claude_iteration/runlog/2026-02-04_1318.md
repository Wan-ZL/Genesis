# Run Log: 2026-02-04 13:18

## Focus
Issue #26: [Bug] Concurrent requests intermittently fail with Internal Server Error

## Changes
- `assistant/server/services/settings.py`:
  - Added `ConnectionPool` class matching the pattern from `memory.py`
  - Added `PooledConnection` context manager for pooled connections
  - Updated `SettingsService` to use connection pool with WAL mode
  - Added `_get_connection()` helper method
  - Replaced all `aiosqlite.connect(self.db_path)` calls with `self._get_connection()`
  - Enabled WAL mode for better concurrency (PRAGMA journal_mode=WAL)
  - Added 30-second busy timeout (PRAGMA busy_timeout=30000)
  - Optimized synchronous mode for WAL (PRAGMA synchronous=NORMAL)
  - Connection pool size: 3 connections

## Root Cause Analysis
The Criticizer discovered that concurrent POST requests to /api/chat were failing with "Internal Server Error" (HTTP 500) at a 20-40% failure rate. The error logs showed "sqlite3.OperationalError: database is locked" during concurrent requests.

Investigation revealed:
1. `MemoryService` was already using connection pooling with WAL mode
2. `SettingsService` was creating new connections on every call via `aiosqlite.connect()`
3. Without WAL mode or busy timeout, SQLite defaulted to exclusive locking
4. Concurrent chat requests hit both MemoryService (conversation storage) and SettingsService (model config)
5. The SettingsService became the bottleneck, causing lock contention

## Result
SUCCESS - Issue #26 implementation complete. All acceptance criteria met:
- [x] Settings service now uses connection pool (3 connections)
- [x] WAL mode enabled for concurrent read/write support
- [x] 30-second busy timeout prevents immediate lock errors
- [x] Pattern matches MemoryService's proven approach
- [x] Existing tests pass (43/44, one pre-existing test expectation issue unrelated to fix)

## How to Test
```bash
cd $GENESIS_DIR/assistant

# Run settings tests
python3 -m pytest tests/test_settings.py -v

# Test concurrent requests manually (from issue description)
python3 -m server.main &
SERVER_PID=$!

# Send 10 concurrent chat requests
for i in {1..10}; do
  curl -s -X POST http://127.0.0.1:8080/api/chat \
    -H "Content-Type: application/json" \
    -d '{"message": "test '$i'"}' > /tmp/test_$i.json &
done
wait

# Check results - all should succeed now
for i in {1..10}; do
  if grep -q '"response"' /tmp/test_$i.json; then
    echo "Request $i: SUCCESS"
  else
    echo "Request $i: FAILED"
    cat /tmp/test_$i.json
  fi
done

# Cleanup
kill $SERVER_PID
rm /tmp/test_*.json
```

## Next Steps
1. Mark Issue #26 with `needs-verification` label
2. Criticizer should verify concurrent requests now succeed
3. Consider applying same fix to other services (alerts, auth, scheduler, audit_log) in future issues

## Technical Notes
- WAL mode allows multiple readers and one writer concurrently
- Busy timeout of 30 seconds gives ample time for locks to be released
- Connection pool size of 3 is sufficient for typical concurrent load
- This fix specifically addresses SettingsService, which is hit on every chat request
- Other services with direct `aiosqlite.connect()` may still have concurrency issues but are less frequently accessed
