# Run Log: 2026-02-04 13:16

## Focus
Issue #15: Add authentication layer for remote access

## Changes
- `assistant/requirements.txt`:
  - Added PyJWT>=2.8.0 for JWT token handling
  - Added bcrypt>=4.1.0 for password hashing

- `assistant/server/services/auth.py` (NEW):
  - `AuthConfig` class with dynamic environment variable reading
    - `is_enabled()`, `get_username()`, `get_password_hash()`, etc.
    - `generate_secret_key()` for JWT secret generation
    - `hash_password()`, `verify_password()` using bcrypt
  - `AuthService` class for authentication management:
    - JWT token creation (access + refresh tokens)
    - Token verification with expiration checking
    - Session tracking with SQLite storage
    - Rate limiting for login attempts (configurable per-IP)
    - Token revocation support
    - Password management (hash storage in DB)

- `assistant/server/routes/auth.py` (NEW):
  - `GET /api/auth/status` - Check auth status and active sessions
  - `POST /api/auth/login` - Authenticate and receive JWT tokens
  - `POST /api/auth/logout` - Revoke current token
  - `POST /api/auth/logout-all` - Revoke all sessions
  - `POST /api/auth/refresh` - Get new access token
  - `POST /api/auth/set-password` - Set initial password
  - `POST /api/auth/change-password` - Change password (requires auth)
  - `require_auth` dependency for protected routes

- `assistant/server/main.py`:
  - Added auth router inclusion
  - Added authentication middleware for protected routes
  - Defined PUBLIC_PATHS for routes that don't require auth
  - Middleware checks JWT token when auth is enabled

- `assistant/tests/test_auth.py` (NEW):
  - 36 tests covering:
    - Password hashing and verification
    - Token creation and verification
    - Rate limiting
    - Token revocation
    - API endpoints (login, logout, refresh, etc.)
    - Protected route access
    - Auth disabled mode

- `assistant/tests/conftest.py` (NEW):
  - Global test configuration to disable auth by default
  - Ensures existing tests continue working

## Result
SUCCESS - Issue #15 authentication layer implemented. All acceptance criteria met:
- [x] Basic authentication middleware (username/password)
- [x] JWT token-based session management
- [x] Configurable via environment variables (ASSISTANT_AUTH_ENABLED, etc.)
- [x] Secure cookie handling (httpOnly, secure, sameSite)
- [x] Login endpoint: POST /api/auth/login
- [x] Logout endpoint: POST /api/auth/logout
- [x] Protected routes require valid token
- [x] Graceful fallback when auth disabled (local-only mode)

## Tests
- 576 tests passing (36 new for authentication)
- All existing tests continue to work with auth disabled

## Environment Variables
```
ASSISTANT_AUTH_ENABLED=true|false (default: false)
ASSISTANT_AUTH_USERNAME=admin (default: admin)
ASSISTANT_AUTH_PASSWORD_HASH= (set via /api/auth/set-password)
ASSISTANT_JWT_SECRET= (auto-generated if not set)
ASSISTANT_TOKEN_EXPIRE_MINUTES=60 (default: 60)
ASSISTANT_REFRESH_TOKEN_EXPIRE_DAYS=7 (default: 7)
ASSISTANT_MAX_LOGIN_ATTEMPTS=5 (default: 5)
ASSISTANT_LOGIN_LOCKOUT_MINUTES=15 (default: 15)
```

## Next
Add `needs-verification` label to Issue #15 for Criticizer verification.
