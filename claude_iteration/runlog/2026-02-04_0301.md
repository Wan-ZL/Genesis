# Run Log: 2026-02-04 03:01

## Focus
Issue #12: Add resource monitoring and limits

## Changes
- `assistant/requirements.txt`: Added psutil>=5.9.0 dependency

- `assistant/server/services/resources.py`: Created ResourceService
  - `ResourceConfig` dataclass with configurable limits:
    - Memory: max_memory_mb, warning/critical percent thresholds
    - CPU: warning/critical percent thresholds
    - Disk: warning/critical GB thresholds
    - Rate limiting: max_requests_per_minute, window_seconds
    - Cleanup: file_max_age_days, cleanup_check_interval_hours
    - Memory cleanup: threshold percent
  - `get_memory_usage()` - Process and system memory statistics
  - `get_cpu_usage()` - Process and system CPU statistics
  - `get_disk_usage()` - Disk space statistics
  - `get_snapshot()` - Complete resource snapshot with status
  - `check_rate_limit()` / `record_request()` - Per-client rate limiting
  - `cleanup_old_files()` - Delete files older than max_age_days
  - `cleanup_memory()` - Garbage collection and cache clearing
  - `check_and_alert()` - Status check with warning callbacks
  - `ResourceStatus` enum (HEALTHY, WARNING, CRITICAL)

- `assistant/server/routes/resources.py`: Created API endpoints
  - `GET /api/resources` - Full resource status
  - `GET /api/resources/memory` - Memory details
  - `GET /api/resources/cpu` - CPU details
  - `GET /api/resources/disk` - Disk details
  - `GET /api/resources/rate-limit` - Check rate limit for client
  - `POST /api/resources/cleanup/files` - Run file cleanup
  - `POST /api/resources/cleanup/memory` - Run memory cleanup
  - `GET/POST /api/resources/limits` - Get/update limits
  - `POST /api/resources/check` - Check status and trigger alerts

- `assistant/server/routes/metrics.py`: Added resource summary to /api/metrics
  - Now includes memory_mb, cpu_percent, disk_percent, status

- `assistant/server/main.py`: Added resources router

- `assistant/cli/__main__.py`: Added CLI commands
  - `python -m cli resources` - Show resource usage
  - `python -m cli resources --json` - JSON output
  - `python -m cli resources cleanup` - Clean up old files
  - `python -m cli resources cleanup --dry-run` - Preview cleanup
  - `python -m cli resources memory` - Clean up memory

- `assistant/tests/test_resources.py`: 48 comprehensive tests
  - ResourceConfig defaults and customization
  - Memory/CPU/Disk usage tracking
  - Status threshold detection
  - Rate limiting (per-client, window expiry)
  - File cleanup (dry-run, actual delete, edge cases)
  - Memory cleanup
  - Warning callbacks
  - Global instance management

## Result
SUCCESS - All acceptance criteria implemented:
- [x] Resource metrics in /api/metrics endpoint (memory_mb, cpu_percent, disk_percent)
- [x] Configurable limits (max_memory_mb, max_request_rate)
- [x] Automatic warning when thresholds approached
- [x] CLI command: `python -m assistant.cli resources` showing current usage
- [x] Old file cleanup policy (e.g., delete uploads older than 30 days)
- [x] Memory cleanup triggered when threshold exceeded

## Tests
- 48 new tests for resource monitoring
- 442 total tests, all passing

## Next
Add `needs-verification` label to Issue #12 and comment with test instructions for Criticizer.
