# Runlog 2026-02-11 15:30

## Issue Completed
**Issue #45: Long-term memory - user preference extraction and recall**

## What Changed

### 1. MemoryExtractor Service (`assistant/server/services/memory_extractor.py`)
- LLM-based fact extraction from conversations using GPT-4o-mini
- Structured JSON extraction with confidence scoring (0.0-1.0)
- Five fact types: preference, personal_info, work_context, behavioral_pattern, temporal
- Filters facts below 0.5 confidence threshold
- Runs async after each assistant response (non-blocking)

### 2. SQLite Facts Storage
- Facts table with: id, fact_type, key, value, source_conversation_id, source_message_id, confidence, created_at, updated_at
- FTS5 virtual table for full-text keyword search
- Automatic triggers (INSERT/UPDATE/DELETE) to keep FTS5 in sync
- Deduplication: Updates existing facts with same (fact_type, key) if new fact has higher confidence
- Connection pool with WAL mode for concurrent access

### 3. MemoryRecall Functionality
- `recall_facts(query, fact_types, limit)` retrieves relevant facts
- FTS5 search when query provided, otherwise returns highest confidence facts
- `format_facts_for_system_prompt()` creates "What I know about you:" section
- Groupsacts by type with formatted output

### 4. API Endpoints (`assistant/server/routes/memory_facts.py`)
- `GET /api/memory/facts` - List all facts with pagination (limit, offset, fact_type filter)
- `GET /api/memory/facts/{id}` - Get specific fact by ID
- `DELETE /api/memory/facts/{id}` - Delete specific fact
- `DELETE /api/memory/facts` - Clear all facts
- `GET /api/memory/search?q=X` - FTS5 search with optional fact_type filter

### 5. CLI Commands (`assistant/cli/__main__.py`)
- `python -m cli memory list` - Show all stored facts (grouped by type)
- `python -m cli memory forget <id>` - Delete specific memory (requires --confirm)
- `python -m cli memory forget-all` - Clear all memories (requires --confirm)
- Added memory_extractor import and routing

### 6. Chat Integration (`assistant/server/routes/chat.py`)
- Added `_extract_facts_async()` helper function
- Before response: Recalls top 10 relevant facts using user message as query
- Injects facts into system prompt after base prompt, before tool suggestions
- After response: Creates async task for fact extraction (non-blocking)
- Works for both `/api/chat` and `/api/chat/stream` endpoints

### 7. Main.py Updates
- Added memory_facts router import and registration

### 8. Tests (35 new tests, 1158 total)
- `tests/test_memory_extractor.py` (22 tests):
  - Fact extraction with mocked LLM
  - Confidence filtering
  - Storage and retrieval
  - Deduplication logic
  - FTS5 search
  - Fact deletion
  - Database integrity
- `tests/test_memory_facts_api.py` (13 tests):
  - List/get/delete endpoints
  - Search endpoint
  - Pagination and filtering
  - Error handling

## Test Results
- Memory tests: 35/35 passed
- Total tests: 1158 (up from 1015)
- All memory tests pass with 0 failures

## Key Design Decisions

1. **Separate database**: Facts stored in `assistant/memory/facts.db` (not in conversations.db) to avoid conflicts
2. **Lightweight extraction**: Uses GPT-4o-mini for cost efficiency
3. **Async extraction**: Runs after response sent, doesn't block API
4. **Keyword search**: FTS5 (not vector DB) sufficient for single-user scale
5. **Confidence-based deduplication**: Only updates if new fact has higher confidence
6. **System prompt injection**: Facts appear before tool suggestions
7. **User transparency**: CLI and API allow users to see and delete facts

## Edge Cases Handled

1. LLM extraction failures → Returns empty list, logs error
2. Low confidence facts → Filtered out (threshold 0.5)
3. Incomplete fact data → Skipped with warning
4. Concurrent access → Connection pool with WAL mode
5. Async extraction errors → Caught and logged, doesn't affect response
6. FTS5 sync → Automatic triggers
7. Empty fact list → Returns empty string for injection

## How to Test

### Basic Flow
```bash
# Start server
cd /Volumes/Storage/Server/Startup/Genesis/assistant
python3 -m server.main

# Have conversation with facts
curl -X POST http://127.0.0.1:8080/api/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "I work at Genesis startup. Keep answers concise."}'

# Wait for async extraction
sleep 3

# View extracted facts
python3 -m cli memory list

# Next response should recall facts
curl -X POST http://127.0.0.1:8080/api/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "What do you know about me?"}'
```

### API Testing
```bash
# List facts
curl http://127.0.0.1:8080/api/memory/facts

# Search facts
curl "http://127.0.0.1:8080/api/memory/search?q=Genesis"

# Delete fact
curl -X DELETE http://127.0.0.1:8080/api/memory/facts/<fact_id>
```

### Unit Tests
```bash
# Memory tests only
python3 -m pytest tests/test_memory_extractor.py tests/test_memory_facts_api.py -v

# Full suite
python3 -m pytest tests/ -q
```

## Files Modified/Created

### Created
- `assistant/server/services/memory_extractor.py` (623 lines)
- `assistant/server/routes/memory_facts.py` (164 lines)
- `assistant/tests/test_memory_extractor.py` (476 lines)
- `assistant/tests/test_memory_facts_api.py` (247 lines)

### Modified
- `assistant/server/routes/chat.py` (added memory recall and extraction integration)
- `assistant/server/main.py` (added memory_facts router)
- `assistant/cli/__main__.py` (added memory commands)
- `claude_iteration/state.md` (updated current focus and done list)

## Next Actions

- Issue #45 marked with `needs-verification` label
- Detailed comment posted with test instructions
- Ready for Criticizer verification

## Blockers
None.

## Notes

- Extraction uses GPT-4o-mini to minimize cost (can be configured)
- Facts database is separate from conversations database
- All tests pass with 0 failures
- Follows existing patterns (ConnectionPool, @with_db_retry, etc.)
- Implements all acceptance criteria from issue #45
